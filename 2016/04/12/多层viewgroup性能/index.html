<!DOCTYPE html><html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="个人博客"><title>多层ViewGroup性能 | 刘伟的个人博客</title><link rel="stylesheet" type="text/css" href="/css/normalize.css"><link rel="stylesheet" type="text/css" href="/css/highlight.css"><link rel="stylesheet" type="text/css" href="/css/very-simple.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.min.css"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"></head><body><!-- include the sidebar--><!-- include ./includes/sidebar.jade--><!-- Blog title and subtitle--><header><div class="container header"><a id="logo" href="/." class="title">刘伟的个人博客</a><span class="subtitle">天生我才必有用</span><label id="toggle-menu" for="menu" onclick><i class="fa fa-bars"></i></label></div></header><!-- use checkbox hack for toggle nav-bar on small screens--><input id="menu" type="checkbox"><!-- Navigation Links--><nav id="nav"><div class="container"><a href="/" class="sidebar-nav-item active">Home</a><a href="/archives" class="sidebar-nav-item">Archives</a></div></nav><div id="header-margin-bar"></div><!-- gallery that comes before the header--><div class="wrapper"><div class="container post-header"><h1>多层ViewGroup性能</h1></div></div><div class="wrapper"><div class="container meta"><div class="post-time">2016-04-12</div><div class="post-tags"><a class="post-tag-link" href="/tags/性能-布局/">性能,布局</a></div></div></div><article><div class="container post"><p>&emsp;&emsp;回溯到2009年，罗马一个家伙写了一篇很有意思的文章，解释了使用RelativeLayout相比于使用LinearLayout的一些好处。不幸的是，很多人读了那篇文章之后，都信奉用RelativeLayout是更好的选择。然而，这却是一个完全错误的结论。<br>&emsp;&emsp;然而这篇文章是非常好的，它提供了一些方法去减少布局的深度，和UI组件的使用数量。当然，第一条原则就是尽可能的去让你的布局扁平化，减少不必要的viewGroup组件，使用merge标签等。<br>&emsp;&emsp;然而文章说的那些方案，并不能保证RelativeLayout会比LinearLayout表现出更好的性能。事实上你去检查RelativeLayout的实现，你会发现，RelativeLayout会调用子View的onMeasure方法两次！这必然会降低性能。如果RelativeLayout没有很深的子View层次，这种性能的影响可能还没那么严重，但是RelativeLayout如果作为一个布局的根View，并且包含很多的子View，那么这种性能影响可能很大。所以最好避免使用RelativeLayout作为布局的根View。<br>当LinearLayout使用Weight属性的时候，为了去准确测量出所有子view的尺寸，同样存在上面的问题（会调用子View的onMeasure两次）。所以使用LinearLayout的时候要注意Weight属性的使用。<br>&emsp;&emsp;另外在View使用中还有一件需要注意的事情就是，listView的使用性能。listview使用wrap_content属性同样会降低性能，因为listview存在很多行元素，测量会比较耗时。所以说除非是不得已，否则一定要用match_parent。<br>&emsp;&emsp;下面我们会给一些简单的例子来说明这些问题。<br>&emsp;&emsp;假设我们的Activity加载这样一个布局，根View是用RelativeLayout，里面有一个子View是ListView，ListView的布局属性是wrap_content。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;RelativeLayout  </span><br><span class="line">    xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot;  </span><br><span class="line">    android:layout_width=&quot;match_parent&quot;  </span><br><span class="line">    android:layout_height=&quot;match_parent&quot; &gt;  </span><br><span class="line">  </span><br><span class="line">    &lt;ListView  </span><br><span class="line">        android:id=&quot;@+id/mylist&quot;  </span><br><span class="line">        android:layout_width=&quot;wrap_content&quot;  </span><br><span class="line">        android:layout_height=&quot;wrap_content&quot; /&gt;  </span><br><span class="line">&lt;/RelativeLayout&gt;</span><br></pre></td></tr></table></figure></p>
<p>&emsp;&emsp;然后我们提供一个BaseAdapter，加载下面的布局作为ListView每行的布局。注意到这里的布局的根View也是RelativeLayout。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&lt;RelativeLayout  </span><br><span class="line">    xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot;  </span><br><span class="line">    android:layout_width=&quot;wrap_content&quot;  </span><br><span class="line">    android:layout_height=&quot;wrap_content&quot;  </span><br><span class="line">    &gt;  </span><br><span class="line">      </span><br><span class="line">    &lt;TextView  </span><br><span class="line">        android:layout_width=&quot;wrap_content&quot;  </span><br><span class="line">        android:layout_height=&quot;wrap_content&quot;  </span><br><span class="line">        android:text=&quot;@string/some_text&quot;  </span><br><span class="line">        /&gt;  </span><br><span class="line">      </span><br><span class="line">&lt;/RelativeLayout&gt;</span><br></pre></td></tr></table></figure></p>
<p>&emsp;&emsp;运行上面的试验，ListView在屏幕上面创建了20行数据，但是我们发现onMeasure一共被调用了320次！<br>&emsp;&emsp;通过上面的分析，我们知道这里有三个点可以去做优化。</p>
<pre><code>1. 把Activity布局的RelativeLayout改成LinearLayout
2. 把ListView的属性从wrap_content改为match_parent
3. 把ListView每行布局的RelativeLayout改为LinearLayout
</code></pre><p>&emsp;&emsp;果不其然，我们发现优化之后，onMeasure的调用降低到了40次（降低8倍），同时Activity的加载时间降低了100ms（这个依赖设备）。当然，如果我们对一个更加复杂的View去做优化会有更好的效果。<br>&emsp;&emsp;在4.4的系统中，做了一些缓存策略去优化这种过度的onMeasure调用。</p>
</div><!-- comment system--><div class="container"><hr></div></article><footer id="footer"><div class="container"><div class="bar"><div class="social"><a href="https://github.com/https://github.com/jasonlliu" target="_blank"><i class="fa fa-github"></i></a></div><div class="footer">© 2016 <a href="/" rel="nofollow">刘伟的个人博客</a>. Powered by <a rel="nofollow" target="_blank" href="https://hexo.io">Hexo</a>. Theme <a target="_blank" href="https://github.com/lotabout/very-simple">very-simple</a>.</div></div></div></footer><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.css"><script src="//cdn.bootcss.com/jquery/2.0.3/jquery.min.js"></script><script src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js"></script><script>$(document).ready(function() {
    $(".fancybox").fancybox();
});</script></body></html>